<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Patient Chat Windows</title>
  <link rel="icon" type="image/png" href="/static/images/logo.png">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 600: '#4f46e5' } }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar"
           class="fixed inset-y-0 left-0 z-40 w-72 -translate-x-full border-r border-slate-200 bg-white px-3 py-4 transition-transform lg:static lg:translate-x-0">
      
      <div class="mb-4 flex items-center gap-2 px-3">
        
        <span class="font-semibold">Provider</span>
      </div>

      <!-- Nav -->
      <nav class="space-y-6 overflow-y-auto px-1">
        <div>
          <p class="mb-2 px-2 text-xs font-semibold uppercase tracking-wide text-slate-400">Pages</p>
          <ul class="space-y-1">
            <li>
              <a href="/provider/dashboard"
                 class="group flex items-center gap-3 rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100">
                <svg class="h-5 w-5 text-slate-400 group-hover:text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                  <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"/>
                </svg>
                <span>Dashboard</span>
              </a>
            </li>
            <li>
              <!-- Active item -->
              <a href="/provider/chat-windows"
                 class="group flex items-center gap-3 rounded-lg px-3 py-2 text-slate-800 bg-indigo-50 ring-1 ring-inset ring-indigo-100">
                <svg class="h-5 w-5 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                  <path d="M8 10h8M8 14h5"/><path d="M21 12a8.5 8.5 0 01-1.6 5l.6 3-3-1a8.5 8.5 0 11-2-14.5"/>
                </svg>
                <span>Chat Windows</span>
              </a>
            </li>
            <li>
              <a href="/provider/patient-progress"
                 class="group flex items-center gap-3 rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100">
                <svg class="h-5 w-5 text-slate-400 group-hover:text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                  <path d="M4 19V5m4 14V9m4 10V7m4 12V4"/>
                </svg>
                <span>Patient Progress</span>
              </a>
            </li>
            <li>
              <a href="/provider/settings"
                 class="group flex items-center gap-3 rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100">
                <svg class="h-5 w-5 text-slate-400 group-hover:text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
                  <path d="M10 6h4l1 2 2 1v4l-2 1-1 2h-4l-1-2-2-1V9l2-1 1-2z"/><circle cx="12" cy="12" r="2.5"/>
                </svg>
                <span>Settings</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Overlay for mobile -->
    <div id="overlay" class="fixed inset-0 z-30 hidden bg-black/30 lg:hidden"></div>

    <!-- Main column -->
    <div class="flex-1 min-w-0 flex flex-col">
      <!-- Top bar -->
      <header class="sticky top-0 z-30 flex h-14 items-center gap-3 border-b border-slate-200 bg-white/80 px-4 backdrop-blur">
        <!-- Mobile menu -->
        <button id="menuBtn" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 lg:hidden">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          <span class="text-sm">Menu</span>
        </button>

        <!-- Page title -->
        <h1 class="text-lg font-semibold">Manage Patient Chat Windows</h1>

        <!-- Right -->
        <div class="ml-auto flex items-center gap-3">
          <button onclick="logout()"
                  class="rounded-md border border-slate-200 px-3 py-1.5 text-sm font-medium text-slate-700 hover:bg-slate-100">
            Logout
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="w-full p-6">

        <div class="mb-4 text-sm text-slate-500" id="breadcrumb">
          <button class="text-indigo-600 hover:underline" onclick="showPatientSelection()">Patients</button>
        </div>

        <!-- Patient Selection View -->
        <section id="patientSelection" class="block">
          <div class="mb-6 rounded-xl bg-white p-6 text-center shadow-sm ring-1 ring-slate-100">
            <h2 class="mb-1 text-xl font-semibold">Select a Patient</h2>
            <p class="text-slate-600">Choose a patient to manage their chat windows and therapeutic sessions</p>
          </div>

          <div id="patientsGrid"
               class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
            <!-- injected -->
          </div>
        </section>

        <!-- Windows Management View -->
        <section id="windowsManagement" class="hidden">
          <div class="mb-6 flex items-center justify-between rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-100">
            <div>
              <h2 id="selectedPatientName" class="text-lg font-semibold">Patient Name</h2>
              <p id="selectedPatientEmail" class="text-slate-600">patient@email.com</p>
            </div>
            <button class="rounded-lg bg-gradient-to-r from-sky-300 to-sky-700 px-4 py-2 font-semibold text-white hover:shadow"
                    onclick="openCreateModal()">
              + Create New Window
            </button>
          </div>

          <div id="windowsList" class="grid gap-4">

          </div>

          <div id="emptyState" class="hidden text-center italic text-slate-600">
            No chat windows created yet for this patient.
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div id="windowModal"
       class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-xl bg-white p-6">
      <div class="mb-6 flex items-center justify-between">
        <h2 id="modalTitle" class="text-xl font-semibold">Create Chat Window</h2>
        <button class="text-2xl leading-none text-slate-500 hover:text-slate-700" onclick="closeModal()">&times;</button>
      </div>

      <form id="windowForm" class="space-y-5">
        <div>
          <label class="mb-1 block font-semibold">Window Title</label>
          <input id="windowTitle" type="text" required placeholder="e.g., Week 1 - Anxiety Management"
                 class="w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400"/>
        </div>

        <div>
          <label class="mb-1 block font-semibold">Description</label>
          <textarea id="windowDescription" placeholder="Brief description of this chat window's purpose..."
                    class="w-full min-h-[100px] resize-y rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400"></textarea>
        </div>

        <div>
          <label class="mb-1 block font-semibold">Time Period</label>
          <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm text-slate-700">Start Date</label>
              <input id="startDate" type="datetime-local" required
                     class="w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400"/>
            </div>
            <div>
              <label class="mb-1 block text-sm text-slate-700">End Date</label>
              <input id="endDate" type="datetime-local" required
                     class="w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400"/>
            </div>
          </div>
        </div>

        <div>
          <label class="mb-2 block font-semibold">Chat Templates</label>
          <div id="templatesEditor" class="rounded-lg border-2 border-slate-200 bg-slate-50 p-3"></div>
          <button type="button" class="mt-3 rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-700"
                  onclick="addTemplateEditor()">+ Add Chat Template</button>
        </div>

        <div>
          <label class="mb-2 block font-semibold">Report Configuration</label>
          <p class="mb-3 text-sm text-slate-600">Configure which components will be included in the automatic report generated when this window completes.</p>

          <div class="space-y-3">
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="window_config_ai_summary" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>AI Summary</strong> ‚Äî Intelligent analysis of conversation themes and progress</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="window_config_saved_messages" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Saved Messages</strong> ‚Äî Important messages flagged during sessions</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="window_config_descriptive_stats" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Descriptive Statistics</strong> ‚Äî Message counts, word counts, session duration</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="window_config_nlp_analysis" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>NLP Analysis</strong> ‚Äî Sentiment analysis and communication patterns</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="window_config_cooccurrence_analysis" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Co-occurrence Analysis</strong> ‚Äî Word relationship network showing conversation themes</span>
            </label>
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-3 border-t border-slate-200 pt-4">
          <button type="button" class="rounded-md bg-slate-100 px-4 py-2 font-medium text-slate-700 hover:bg-slate-200"
                  onclick="closeModal()">Cancel</button>
          <button type="submit" class="rounded-md bg-gradient-to-r from-sky-300 to-sky-700 px-5 py-2 font-semibold text-white hover:shadow">
            Save Window
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Configuration Modal -->
  <div id="reportConfigModal"
       class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-2xl rounded-xl bg-white p-6">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-xl font-semibold">Configure Enhanced Report</h2>
        <button class="text-2xl leading-none text-slate-500 hover:text-slate-700" onclick="closeReportConfigModal()">&times;</button>
      </div>

      <form id="reportConfigForm" class="space-y-5">
        <div>
          <p class="mb-2 font-semibold">Select Report Components:</p>
          <div class="space-y-3">
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="config_ai_summary" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>AI Summary</strong> ‚Äî Intelligent analysis of conversation themes and progress</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="config_saved_messages" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Saved Messages</strong> ‚Äî Important messages flagged during sessions</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="config_descriptive_stats" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Descriptive Statistics</strong> ‚Äî Message counts, word counts, session duration</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="config_nlp_analysis" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>NLP Analysis</strong> ‚Äî Sentiment analysis and communication patterns</span>
            </label>
            <label class="flex gap-3 rounded-lg border-2 border-transparent bg-slate-50 p-3 hover:border-indigo-300">
              <input id="config_cooccurrence_analysis" type="checkbox" checked class="mt-1 h-5 w-5">
              <span><strong>Co-occurrence Analysis</strong> ‚Äî Word relationship network showing conversation themes</span>
            </label>
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-3 border-t border-slate-200 pt-4">
          <button type="button" class="rounded-md bg-slate-100 px-4 py-2 font-medium text-slate-700 hover:bg-slate-200"
                  onclick="closeReportConfigModal()">Cancel</button>
          <button type="submit" class="rounded-md bg-gradient-to-r from-sky-300 to-sky-700 px-5 py-2 font-semibold text-white hover:shadow">
            Generate Enhanced Report
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>

    const menuBtn  = document.getElementById('menuBtn');
    const sidebar  = document.getElementById('sidebar');
    const overlay  = document.getElementById('overlay');
    const openSide  = () => { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
    const closeSide = () => { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }

    if (menuBtn) {
      menuBtn.addEventListener('click', () => {
        const open = sidebar.classList.contains('-translate-x-full');
        open ? openSide() : closeSide();
      });
      overlay.addEventListener('click', closeSide);
      if (window.innerWidth >= 1024) sidebar.classList.remove('-translate-x-full');
    }

    let patients = [];
    let currentPatient = null;
    let windows = [];
    let models = [];
    let systemPrompts = [];
    let currentWindowId = null;
    let currentReportWindowId = null;

    function formatDate(timestamp){ return new Date(timestamp * 1000).toLocaleDateString(); }
    function formatDateTimeLocal(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      const h = String(date.getHours()).padStart(2,'0');
      const min = String(date.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${d}T${h}:${min}`;
    }

    async function loadPatients() {
      try {
        const res = await fetch('/api/provider/patients');
        patients = await res.json();
        displayPatients();
      } catch (e) { console.error('Error loading patients:', e); }
    }

    function displayPatients() {
      const grid = document.getElementById('patientsGrid');
      grid.innerHTML = patients.map(p => `
        <div class="cursor-pointer rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-100 transition hover:shadow-md"
             onclick="selectPatient(${p.id})">
          <div class="mb-1 text-base font-semibold text-slate-900">${p.username}</div>
          <div class="mb-3 text-sm text-slate-600">${p.email}</div>
          <div class="flex justify-between text-sm text-slate-500">
            <span>Conversations: ${p.conversation_count}</span>
            <span>Last Active: ${p.last_active ? formatDate(p.last_active) : 'Never'}</span>
          </div>
        </div>
      `).join('');
    }

    async function selectPatient(patientId) {
      currentPatient = patients.find(p => p.id === patientId);
      if (!currentPatient) return;

      document.getElementById('breadcrumb').innerHTML = `
        <button class="text-indigo-600 hover:underline" onclick="showPatientSelection()">Patients</button>
        <span class="mx-1">‚Ä∫</span>
        <span class="text-slate-700">${currentPatient.username}</span>
      `;

      document.getElementById('selectedPatientName').textContent = currentPatient.username;
      document.getElementById('selectedPatientEmail').textContent = currentPatient.email;

      document.getElementById('patientSelection').classList.add('hidden');
      document.getElementById('windowsManagement').classList.remove('hidden');

      await loadWindows(patientId);
    }

    function showPatientSelection() {
      document.getElementById('patientSelection').classList.remove('hidden');
      document.getElementById('windowsManagement').classList.add('hidden');
      document.getElementById('breadcrumb').innerHTML = `
        <button class="text-indigo-600 hover:underline" onclick="showPatientSelection()">Patients</button>
      `;
      currentPatient = null;
    }

    // ===== Windows =====
    async function loadWindows(patientId) {
      try {
        const res = await fetch(`/api/windows?patient_id=${patientId}`);
        windows = await res.json();
        displayWindows();
      } catch (e) { console.error('Error loading windows:', e); }
    }

    function displayWindows() {
      const list = document.getElementById('windowsList');
      const empty = document.getElementById('emptyState');

      if (!windows.length) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      list.innerHTML = windows.map(w => {
        let status = 'scheduled';
        if (!w.is_active) status = 'inactive';
        else if (w.is_current) status = 'active';

        const statusClass = status === 'active'
          ? 'bg-emerald-100 text-emerald-700'
          : status === 'inactive'
            ? 'bg-rose-100 text-rose-700'
            : 'bg-amber-100 text-amber-700';

        return `
          <div class="overflow-hidden rounded-xl bg-white shadow-sm ring-1 ring-slate-100">
            <div class="border-b border-slate-200 bg-slate-50 p-4">
              <div class="mb-2 flex items-start justify-between gap-3">
                <div>
                  <div class="text-base font-semibold text-slate-900">${w.title}</div>
                  <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-slate-600">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 ${statusClass}">${status[0].toUpperCase() + status.slice(1)}</span>
                    <span>üìÖ ${formatDate(w.start_date)} ‚Äì ${formatDate(w.end_date)}</span>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button class="rounded-md border border-slate-200 px-2 py-1 text-sm hover:bg-slate-100"
                          title="Edit" onclick="editWindow(${w.id})">‚úèÔ∏è</button>
                  <button class="rounded-md border border-slate-200 px-2 py-1 text-sm hover:bg-slate-100 text-rose-600"
                          title="Delete" onclick="deleteWindow(${w.id})">üóëÔ∏è</button>
                  ${!w.is_current && w.is_active ? `
                    <button class="rounded-md border border-slate-200 px-2 py-1 text-sm hover:bg-slate-100"
                            title="Configure & Generate Enhanced Report" onclick="openReportConfigModal(${w.id})">üìä</button>
                    <button class="rounded-md border border-slate-200 px-2 py-1 text-sm hover:bg-slate-100"
                            title="Generate Basic Report" onclick="generateReport(${w.id})">üìÑ</button>
                  ` : ''}
                </div>
              </div>
              ${w.description ? `<p class="text-sm text-slate-700">${w.description}</p>` : ''}
            </div>

            <div class="p-4">
              <h4 class="mb-3 text-sm font-semibold text-slate-800">Configured Chats (${w.templates ? w.templates.length : 0})</h4>
              ${w.templates && w.templates.length ? `
                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
                  ${w.templates.map(t => `
                    <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                      <div class="mb-1 text-sm font-semibold text-slate-900">${t.title}</div>
                      ${t.purpose ? `<div class="mb-2 text-sm text-slate-600">${t.purpose}</div>` : ''}
                      <div class="flex items-center justify-between text-xs text-slate-600">
                        <span class="rounded-md bg-sky-100 px-2 py-0.5 font-medium text-sky-700">${t.model || 'Unknown Model'}</span>
                        <span>${t.max_messages ? `Max: ${t.max_messages}` : 'Unlimited'}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : `<div class="py-6 text-center text-slate-600">No chat templates configured</div>`}
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== Models/Prompts =====
    async function loadModels() {
      try { models = await (await fetch('/api/models')).json(); }
      catch(e){ console.error('Error loading models:', e); }
    }
    async function loadSystemPrompts() {
      try { systemPrompts = await (await fetch('/api/system_prompts')).json(); }
      catch(e){ console.error('Error loading prompts:', e); }
    }

    // ===== Modal (Create/Edit) =====
    function openCreateModal() {
      if (!currentPatient) return alert('Please select a patient first');
      currentWindowId = null;

      document.getElementById('modalTitle').textContent = 'Create Chat Window';
      document.getElementById('windowForm').reset();
      document.getElementById('templatesEditor').innerHTML = '';

      document.getElementById('window_config_ai_summary').checked = true;
      document.getElementById('window_config_saved_messages').checked = true;
      document.getElementById('window_config_descriptive_stats').checked = true;
      document.getElementById('window_config_nlp_analysis').checked = true;
      document.getElementById('window_config_cooccurrence_analysis').checked = true;

      addTemplateEditor();
      document.getElementById('windowModal').classList.remove('hidden');
      document.getElementById('windowModal').classList.add('flex');
    }

    function closeModal() {
      const m = document.getElementById('windowModal');
      m.classList.add('hidden');
      m.classList.remove('flex');
    }

    async function editWindow(windowId) {
      try {
        const res = await fetch(`/api/windows/${windowId}`);
        if (!res.ok) throw new Error('Failed to load window data');
        const w = await res.json();

        currentWindowId = windowId;
        document.getElementById('modalTitle').textContent = 'Edit Chat Window';
        document.getElementById('windowTitle').value = w.title || '';
        document.getElementById('windowDescription').value = w.description || '';

        if (w.start_date) {
          const sd = new Date(w.start_date * 1000);
          document.getElementById('startDate').value = formatDateTimeLocal(sd);
        }
        if (w.end_date) {
          const ed = new Date(w.end_date * 1000);
          document.getElementById('endDate').value = formatDateTimeLocal(ed);
        }

        const cfg = w.report_config || {};
        document.getElementById('window_config_ai_summary').checked = cfg.ai_summary !== false;
        document.getElementById('window_config_saved_messages').checked = cfg.saved_messages !== false;
        document.getElementById('window_config_descriptive_stats').checked = cfg.descriptive_stats !== false;
        document.getElementById('window_config_nlp_analysis').checked = cfg.nlp_analysis !== false;
        document.getElementById('window_config_cooccurrence_analysis').checked = cfg.cooccurrence_analysis !== false;

        const editor = document.getElementById('templatesEditor');
        editor.innerHTML = '';
        if (w.templates && w.templates.length) {
          w.templates.forEach((t, i) => {
            addTemplateEditor();
            const el = document.querySelectorAll('.template-editor-item')[i];
            el.querySelector('.template-title-input').value = t.title || '';
            el.querySelector('.template-purpose-input').value = t.purpose || '';
            el.querySelector('.template-model-select').value = t.model_id || '';
            el.querySelector('.template-prompt-select').value = t.system_prompt_id || '';
            el.querySelector('.template-custom-prompt').value = t.custom_system_prompt || '';
          });
        } else addTemplateEditor();

        document.getElementById('windowModal').classList.remove('hidden');
        document.getElementById('windowModal').classList.add('flex');
      } catch (e) {
        console.error('Error loading window for edit:', e);
        alert(`Failed to load window data: ${e.message}`);
      }
    }

    function addTemplateEditor() {
      const editor = document.getElementById('templatesEditor');
      const index = editor.children.length;

      const div = document.createElement('div');
      div.className = 'template-editor-item mb-3 rounded-md border border-slate-200 bg-white p-3';
      div.innerHTML = `
        <div class="mb-3 flex items-center justify-between">
          <strong>Chat Template ${index + 1}</strong>
          <button type="button" class="rounded bg-rose-600 px-2 py-1 text-xs font-medium text-white hover:bg-rose-700" onclick="removeTemplateEditor(this)">Remove</button>
        </div>
        <div class="mb-3">
          <label class="mb-1 block text-sm font-semibold">Template Title</label>
          <input type="text" class="template-title-input w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400" required placeholder="e.g., Anxiety Discussion">
        </div>
        <div class="mb-3">
          <label class="mb-1 block text-sm font-semibold">Purpose</label>
          <textarea class="template-purpose-input w-full min-h-[80px] resize-y rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400" placeholder="What is this chat for?"></textarea>
        </div>
        <div class="mb-3">
          <label class="mb-1 block text-sm font-semibold">Model</label>
          <select class="template-model-select w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400" required>
            ${models.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
          </select>
        </div>
        <div class="mb-3">
          <label class="mb-1 block text-sm font-semibold">System Prompt</label>
          <select class="template-prompt-select w-full rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400">
            <option value="">-- Default --</option>
            ${systemPrompts.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="mb-1 block text-sm font-semibold">Custom Instructions (optional)</label>
          <textarea class="template-custom-prompt w-full min-h-[80px] resize-y rounded-md border-2 border-slate-200 px-3 py-2 outline-none focus:border-indigo-400" placeholder="Additional instructions for this chat..."></textarea>
        </div>
      `;
      editor.appendChild(div);
    }

    function removeTemplateEditor(btn) {
      btn.closest('.template-editor-item').remove();
    }

    document.getElementById('windowForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const templates = [];
      document.querySelectorAll('.template-editor-item').forEach(item => {
        templates.push({
          title: item.querySelector('.template-title-input').value,
          purpose: item.querySelector('.template-purpose-input').value,
          model_id: parseInt(item.querySelector('.template-model-select').value),
          system_prompt_id: item.querySelector('.template-prompt-select').value || null,
          custom_system_prompt: item.querySelector('.template-custom-prompt').value || null
        });
      });

      const report_config = {
        ai_summary: document.getElementById('window_config_ai_summary').checked,
        saved_messages: document.getElementById('window_config_saved_messages').checked,
        descriptive_stats: document.getElementById('window_config_descriptive_stats').checked,
        nlp_analysis: document.getElementById('window_config_nlp_analysis').checked,
        cooccurrence_analysis: document.getElementById('window_config_cooccurrence_analysis').checked
      };

      const payload = {
        title: document.getElementById('windowTitle').value,
        description: document.getElementById('windowDescription').value,
        start_date: new Date(document.getElementById('startDate').value).getTime() / 1000,
        end_date: new Date(document.getElementById('endDate').value).getTime() / 1000,
        templates, report_config
      };

      // Only include patient_id when creating (not editing)
      if (!currentWindowId) {
        payload.patient_id = currentPatient.id;
      }

      try {
        const url = currentWindowId ? `/api/windows/${currentWindowId}` : '/api/windows/';
        const method = currentWindowId ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method, headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to save window');

        closeModal();
        loadWindows(currentPatient.id);
      } catch (e) {
        console.error('Error saving window:', e);
        alert('Failed to save window. Please try again.');
      }
    });

    async function deleteWindow(windowId) {
      if (!confirm('Are you sure you want to delete this chat window?')) return;
      try {
        const res = await fetch(`/api/windows/${windowId}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete window');
        loadWindows(currentPatient.id);
      } catch (e) {
        console.error('Error deleting window:', e);
        alert('Failed to delete window. It may have existing conversations.');
      }
    }

    // ===== Reports =====
    async function generateReport(windowId) {
      if (!confirm('Generate a basic report for this completed window?')) return;
      try {
        const res = await fetch(`/api/reports/window/${windowId}/generate`, { method: 'POST' });
        if (!res.ok) {
          const err = await res.json(); throw new Error(err.error || 'Failed to generate report');
        }
        await res.json();
        alert('Basic report generated successfully!');
        loadWindows(currentPatient.id);
      } catch (e) {
        console.error('Error generating report:', e);
        alert(`Failed to generate report: ${e.message}`);
      }
    }

    async function openReportConfigModal(windowId) {
      currentReportWindowId = windowId;
      try {
        const res = await fetch(`/api/reports/window/${windowId}/config`);
        if (res.ok) {
          const cfg = await res.json();
          document.getElementById('config_ai_summary').checked = cfg.ai_summary !== false;
          document.getElementById('config_saved_messages').checked = cfg.saved_messages !== false;
          document.getElementById('config_descriptive_stats').checked = cfg.descriptive_stats !== false;
          document.getElementById('config_nlp_analysis').checked = cfg.nlp_analysis !== false;
          document.getElementById('config_cooccurrence_analysis').checked = cfg.cooccurrence_analysis !== false;
        }
      } catch (e) { console.error('Error loading report config:', e); }

      const m = document.getElementById('reportConfigModal');
      m.classList.remove('hidden'); m.classList.add('flex');
    }

    function closeReportConfigModal() {
      const m = document.getElementById('reportConfigModal');
      m.classList.add('hidden'); m.classList.remove('flex');
      currentReportWindowId = null;
    }

    document.getElementById('reportConfigForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentReportWindowId) return alert('No window selected');

      const config = {
        ai_summary: document.getElementById('config_ai_summary').checked,
        saved_messages: document.getElementById('config_saved_messages').checked,
        descriptive_stats: document.getElementById('config_descriptive_stats').checked,
        nlp_analysis: document.getElementById('config_nlp_analysis').checked,
        cooccurrence_analysis: document.getElementById('config_cooccurrence_analysis').checked
      };

      try {
        await fetch(`/api/reports/window/${currentReportWindowId}/config`, {
          method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ config })
        });

        const res = await fetch(`/api/reports/window/${currentReportWindowId}/generate-enhanced`, {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ config })
        });
        if (!res.ok) {
          const err = await res.json(); throw new Error(err.error || 'Failed to generate enhanced report');
        }
        await res.json();
        alert('Enhanced report generated successfully!');
        closeReportConfigModal();
        loadWindows(currentPatient.id);
      } catch (e) {
        console.error('Error generating enhanced report:', e);
        alert(`Failed to generate enhanced report: ${e.message}`);
      }
    });

    // ===== Auth =====
    async function logout(){ await fetch('/logout'); window.location.href='/login'; }

    // ===== Init =====
    (async function initialize(){
      await loadModels();
      await loadSystemPrompts();
      await loadPatients();
    })();
  </script>
</body>
</html>
