<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
        }
        
        select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            position: relative;
        }
        
        .message.user {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        
        .message.assistant {
            background: #f1f3f5;
            margin-right: 20%;
        }
        
        .message-content {
            user-select: text;
        }

        .message-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            user-select: none;
        }
        
        .input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }
        
        .input-area textarea {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }
        
        .send-btn {
            padding: 0.75rem 1.5rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .send-btn:hover {
            background: #0056b3;
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            overflow-y: auto;
        }
        
        .sidebar h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .saved-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .saved-item .comment {
            font-style: italic;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .selection-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }
        
        .selection-popup button {
            padding: 0.25rem 0.5rem;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        ::selection {
            background: #ffd700;
            color: black;
        }
        
        .week-indicator {
            text-align: center;
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LLM Chat Interface</h1>
        <div class="controls">
            <select id="modelSelect">
                <!-- Models will be loaded dynamically -->
            </select>
            <select id="promptSelect">
                <!-- System prompts will be loaded dynamically -->
            </select>
            <div class="week-indicator">
                Week <span id="currentWeek"></span> of <span id="currentYear"></span>
            </div>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="main-chat">
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <textarea id="messageInput" placeholder="Type your message..." onkeydown="handleKeyPress(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">Send</button>
            </div>
        </div>
        
        <div class="sidebar">
            <h3>Saved Selections</h3>
            <div id="savedSelections"></div>
        </div>
    </div>
    
    <div class="selection-popup" id="selectionPopup">
        <button onclick="saveSelection()">Save Selection</button>
    </div>
    
    <script>
        let selectedText = '';
        let selectedMessageIds = [];
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        // Initialize week display
        function updateWeekDisplay() {
            const now = new Date();
            const weekNumber = getWeekNumber(now);
            document.getElementById('currentWeek').textContent = weekNumber;
            document.getElementById('currentYear').textContent = now.getFullYear();
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        // Handle text selection
        document.addEventListener('mouseup', function(e) {
            // Don't process if clicking the save button
            if (e.target.closest('#selectionPopup')) return;

            // Small delay to ensure selection is finalized
            setTimeout(function() {
                const selection = window.getSelection();
                const popup = document.getElementById('selectionPopup');

                if (selection.rangeCount === 0) {
                    popup.style.display = 'none';
                    return;
                }

                // Get the selected range
                const range = selection.getRangeAt(0);

                // Check if selection is within messages area
                const messagesDiv = document.getElementById('messages');
                if (!messagesDiv.contains(range.commonAncestorContainer)) {
                    popup.style.display = 'none';
                    return;
                }

                // Extract text, filtering out metadata
                let extractedText = '';
                const fragment = range.cloneContents();

                // Walk through all text nodes and element nodes
                function extractTextFromNode(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        // Check if this text node is inside message-meta
                        let parent = node.parentElement;
                        while (parent && parent !== messagesDiv) {
                            if (parent.classList && parent.classList.contains('message-meta')) {
                                return ''; // Skip metadata
                            }
                            parent = parent.parentElement;
                        }
                        return node.textContent;
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        // Skip message-meta elements entirely
                        if (node.classList && node.classList.contains('message-meta')) {
                            return '';
                        }
                        // Recursively process child nodes
                        let text = '';
                        node.childNodes.forEach(child => {
                            text += extractTextFromNode(child);
                        });
                        return text;
                    }
                    return '';
                }

                extractedText = extractTextFromNode(fragment);
                const trimmedText = extractedText.trim();

                // Debug logging
                console.log('Raw selection:', selection.toString());
                console.log('Extracted text:', extractedText);
                console.log('Trimmed text:', trimmedText);

                if (trimmedText.length > 0) {
                    selectedText = trimmedText;

                    // Find which messages are involved
                    const messages = document.querySelectorAll('.message');
                    selectedMessageIds = [];

                    messages.forEach(msg => {
                        if (selection.containsNode(msg, true)) {
                            const msgId = msg.dataset.messageId;
                            if (msgId) selectedMessageIds.push(msgId);
                        }
                    });

                    // Show popup
                    popup.style.display = 'block';
                    popup.style.left = e.pageX + 'px';
                    popup.style.top = e.pageY + 'px';
                } else {
                    popup.style.display = 'none';
                }
            }, 10);
        });

        // Hide popup when selection is cleared
        document.addEventListener('selectionchange', function() {
            const selection = window.getSelection();
            const popup = document.getElementById('selectionPopup');

            // Don't hide if we're interacting with the popup
            if (document.activeElement && document.activeElement.closest('#selectionPopup')) {
                return;
            }

            const selectionText = selection.toString().trim();
            console.log('Selection changed, text length:', selectionText.length);

            // Hide popup if selection is empty
            if (selectionText.length === 0) {
                console.log('Hiding popup - selection cleared');
                popup.style.display = 'none';
            }
        });
        
        function saveSelection() {
            const comment = prompt('Add a comment (optional):');
            
            fetch('/api/save_selection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    selections: [selectedText],
                    message_ids: selectedMessageIds,
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                loadSavedSelections();
                document.getElementById('selectionPopup').style.display = 'none';
                window.getSelection().removeAllRanges();
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Send to server
            fetch('/api/send_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: message,
                    model_id: parseInt(document.getElementById('modelSelect').value),
                    system_prompt_id: parseInt(document.getElementById('promptSelect').value),
                    timezone: timezone
                })
            })
            .then(response => response.json())
            .then(data => {
                addMessageToChat('assistant', data.response, data.message_id);
                input.value = '';
                sendBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                sendBtn.disabled = false;
            });
        }
        
        function addMessageToChat(role, content, messageId) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            if (messageId) messageDiv.dataset.messageId = messageId;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);

            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            metaDiv.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(metaDiv);

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function loadSavedSelections() {
            fetch('/api/get_saved_selections')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('savedSelections');
                    container.innerHTML = '';
                    
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'saved-item';
                        
                        const text = document.createElement('div');
                        text.textContent = item.selections.join(' ... ');
                        div.appendChild(text);
                        
                        if (item.comment) {
                            const comment = document.createElement('div');
                            comment.className = 'comment';
                            comment.textContent = item.comment;
                            div.appendChild(comment);
                        }
                        
                        container.appendChild(div);
                    });
                });
        }
        
        function loadWeekMessages() {
            const now = new Date();
            const week = getWeekNumber(now);
            const year = now.getFullYear();
            
            fetch(`/api/get_week_messages/${year}/${week}`)
                .then(response => response.json())
                .then(messages => {
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessageToChat(msg.role, msg.content, msg.id);
                    });
                });
        }
        
        function loadModelsAndPrompts() {
            // Load available models
            fetch('/api/get_models')
                .then(response => response.json())
                .then(models => {
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = '';
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading models:', error));
            
            // Load system prompts
            fetch('/api/get_prompts')
                .then(response => response.json())
                .then(prompts => {
                    const promptSelect = document.getElementById('promptSelect');
                    promptSelect.innerHTML = '';
                    prompts.forEach(prompt => {
                        const option = document.createElement('option');
                        option.value = prompt.id;
                        option.textContent = prompt.name;
                        promptSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading prompts:', error));
        }
        
        // Initialize
        updateWeekDisplay();
        loadModelsAndPrompts();
        loadWeekMessages();
        loadSavedSelections();
        
        // Refresh saved selections periodically
        setInterval(loadSavedSelections, 30000);
    </script>
</body>
</html>